import React, { createContext, ReactNode, useContext, useMemo } from 'react';
import { cssStringFromTheme } from '../../css/cssStringFromTheme';
import { ThemeVars } from '../../css/sprinkles.css';
import { lightTheme } from '../../themes/lightTheme';
import { TransactionStoreProvider } from '../../transactions/TransactionStoreContext';
import { AppContext, defaultAppInfo, TermsOfService } from './AppContext';
import { CoolModeContext } from './CoolModeContext';
import {
  RainbowKitChain,
  RainbowKitChainContext,
} from './RainbowKitChainContext';
import { ShowRecentTransactionsContext } from './ShowRecentTransactionsContext';
import { provideRainbowKitChains } from './provideRainbowKitChains';

const ThemeIdContext = createContext<string | undefined>(undefined);

const attr = 'data-rk';

const createThemeRootProps = (id: string | undefined) => ({ [attr]: id || '' });

const createThemeRootSelector = (id: string | undefined) => {
  if (id && !/^[a-zA-Z0-9_]+$/.test(id)) {
    throw new Error(`Invalid ID: ${id}`);
  }

  return id ? `[${attr}="${id}"]` : `[${attr}]`;
};

export const useThemeRootProps = () => {
  const id = useContext(ThemeIdContext);
  return createThemeRootProps(id);
};

export type Theme =
  | ThemeVars
  | {
      lightMode: ThemeVars;
      darkMode: ThemeVars;
    };

export interface RainbowKitProviderProps {
  chains: RainbowKitChain[];
  id?: string;
  children: ReactNode;
  theme?: Theme | null;
  showRecentTransactions?: boolean;
  appInfo?: {
    appName?: string;
    learnMoreUrl?: string;
    termsOfService?: TermsOfService;
  };
  coolMode?: boolean;
}

const defaultTheme = lightTheme();

export function RainbowKitProvider({
  chains,
  id,
  theme = defaultTheme,
  children,
  appInfo,
  showRecentTransactions = false,
  coolMode = false,
}: RainbowKitProviderProps) {
  const rainbowkitChains = useMemo(
    () => provideRainbowKitChains(chains),
    [chains]
  );

  if (typeof theme === 'function') {
    throw new Error(
      'A theme function was provided to the "theme" prop instead of a theme object. You must execute this function to get the resulting theme object.'
    );
  }

  const selector = createThemeRootSelector(id);

  if (!appInfo?.termsOfService?.url && appInfo?.termsOfService?.disclaimerUrl) {
    // eslint-disable-next-line no-console
    console?.warn(
      'A `disclaimerUrl` was provided to the `termsOfService` prop without first providing the terms of service `url`. The disclaimer will not be displayed.'
    );
  }

  const appContext = {
    ...defaultAppInfo,
    ...appInfo,
  };

  return (
    <RainbowKitChainContext.Provider value={rainbowkitChains}>
      <CoolModeContext.Provider value={coolMode}>
        <ShowRecentTransactionsContext.Provider value={showRecentTransactions}>
          <TransactionStoreProvider>
            <AppContext.Provider value={appContext}>
              <ThemeIdContext.Provider value={id}>
                {theme ? (
                  <div {...createThemeRootProps(id)}>
                    <style
                      // eslint-disable-next-line react/no-danger
                      dangerouslySetInnerHTML={{
                        // Selectors are sanitized to only contain alphanumeric
                        // and underscore characters. Theme values generated by
                        // cssStringFromTheme are sanitized, removing
                        // characters that terminate values / HTML tags.
                        __html: [
                          `${selector}{${cssStringFromTheme(
                            'lightMode' in theme ? theme.lightMode : theme
                          )}}`,

                          'darkMode' in theme
                            ? `@media(prefers-color-scheme:dark){${selector}{${cssStringFromTheme(
                                theme.darkMode,
                                { extends: theme.lightMode }
                              )}}}`
                            : null,
                        ].join(''),
                      }}
                    />
                    {children}
                  </div>
                ) : (
                  children
                )}
              </ThemeIdContext.Provider>
            </AppContext.Provider>
          </TransactionStoreProvider>
        </ShowRecentTransactionsContext.Provider>
      </CoolModeContext.Provider>
    </RainbowKitChainContext.Provider>
  );
}
